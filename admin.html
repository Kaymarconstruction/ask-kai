<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard â€“ Ask Kai</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/dist/umd/supabase.min.js"></script>
  <style>
    body {
      background-image: url('https://i.imgur.com/jhqlVA5.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      font-family: sans-serif;
    }
    @media (max-width: 768px) {
      body {
        background-image: url('https://i.imgur.com/qzRmu0O.jpeg');
      }
    }
    .overlay {
      background-color: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(5px);
    }
  </style>
</head>

<body class="text-gray-800">

<div class="max-w-5xl mx-auto p-6 overlay mt-8 rounded-lg shadow space-y-8">
  <h1 class="text-3xl font-bold text-green-600 text-center">Admin Dashboard</h1>

  <!-- Manage Materials Section -->
  <section>
    <h2 class="text-2xl font-semibold text-green-700 mb-4">Manage Materials</h2>
    <div class="flex space-x-2 mb-4">
      <input id="materialName" type="text" placeholder="Material Name" class="border p-2 rounded w-1/3" />
      <input id="materialCategory" type="text" placeholder="Category" class="border p-2 rounded w-1/3" />
      <input id="materialPrice" type="number" placeholder="Price per Unit" class="border p-2 rounded w-1/6" />
      <input id="materialUnit" type="text" placeholder="Unit" class="border p-2 rounded w-1/6" />
      <button onclick="addMaterial()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Add</button>
    </div>
    <div id="materialsList" class="space-y-4"></div>
  </section>

  <!-- Manage Users Section -->
  <section>
    <h2 class="text-2xl font-semibold text-green-700 mb-4">Manage Users</h2>
    <div id="usersList" class="space-y-4"></div>
  </section>

  <a href="index.html" class="text-blue-600 underline text-sm block text-center mt-6">Back to Chat</a>
</div>

<script>
  const SUPABASE_URL = 'https://ndvmxpkoyoimibntetef.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Replace with your real key
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const userEmail = sessionStorage.getItem('askkaiUser');
  if (!userEmail || userEmail !== 'admin@kaymarconstruction.com') {
    alert('Unauthorized access. Redirecting...');
    window.location.href = 'signin.html';
  }

  // Load Materials
  async function loadMaterials() {
    const { data, error } = await supabase.from('materials').select('*');
    const container = document.getElementById('materialsList');
    container.innerHTML = '';

    if (error || !data.length) {
      container.innerHTML = '<p class="text-red-600">No materials found.</p>';
      return;
    }

    data.forEach(mat => {
      const item = document.createElement('div');
      item.className = 'bg-white p-4 rounded shadow flex justify-between items-center';
      item.innerHTML = `
        <div>
          <h3 class="text-xl font-bold text-green-700">${mat.name}</h3>
          <p class="text-sm">Category: ${mat.category}</p>
          <p class="text-sm">Price: $${mat.price_per_unit} per ${mat.unit}</p>
        </div>
        <button onclick="deleteMaterial('${mat.id}')" class="text-red-600 hover:underline">Delete</button>
      `;
      container.appendChild(item);
    });
  }

  // Add Material
  async function addMaterial() {
    const name = document.getElementById('materialName').value.trim();
    const category = document.getElementById('materialCategory').value.trim();
    const price = parseFloat(document.getElementById('materialPrice').value.trim());
    const unit = document.getElementById('materialUnit').value.trim();

    if (!name || !category || !price || !unit) {
      alert('Please fill out all fields.');
      return;
    }

    const { error } = await supabase.from('materials').insert([{ name, category, price_per_unit: price, unit }]);
    if (error) {
      alert('Failed to add material.');
    } else {
      alert('Material added successfully.');
      loadMaterials();
    }
  }

  // Delete Material
  async function deleteMaterial(id) {
    const { error } = await supabase.from('materials').delete().eq('id', id);
    if (!error) loadMaterials();
  }

  // Load Users
  async function loadUsers() {
    const { data, error } = await supabase.from('users').select('name, email, plan_tier');
    const container = document.getElementById('usersList');
    container.innerHTML = '';

    if (error || !data.length) {
      container.innerHTML = '<p class="text-red-600">No users found.</p>';
      return;
    }

    data.forEach(user => {
      const item = document.createElement('div');
      item.className = 'bg-white p-4 rounded shadow flex justify-between items-center';
      item.innerHTML = `
        <div>
          <h3 class="text-lg font-bold text-green-700">${user.name || 'No Name'}</h3>
          <p class="text-sm">Email: ${user.email}</p>
          <p class="text-sm">Plan: ${user.plan_tier}</p>
        </div>
      `;
      container.appendChild(item);
    });
  }

  window.addEventListener('load', () => {
    loadMaterials();
    loadUsers();
  });
</script>

</body>
</html>
