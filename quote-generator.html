<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quote Generator – Ask Kai</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    .kaymar-green { color: #7AC142; }
    .blinking-cursor {
      display: inline-block;
      width: 10px;
      height: 1em;
      background-color: #7AC142;
      margin-left: 4px;
      animation: blink 1s steps(2, start) infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body class="bg-white text-gray-800">

  <!-- Header -->
  <header class="bg-white shadow p-4 flex items-center justify-between">
    <img src="https://i.imgur.com/zcqscCO.png" alt="Kaymar Banner" class="h-12" />
    <div class="flex items-center space-x-4">
      <button onclick="toggleMenu()" class="bg-black text-white p-2 rounded-lg hover:bg-gray-800 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <div id="menuDropdown" class="hidden absolute mt-2 w-56 bg-white border border-gray-300 shadow-lg rounded-md z-10">
        <a href="index.html" class="block px-4 py-2 text-sm text-gray-800 hover:bg-gray-100">Back to Ask Kai</a>
        <a href="upgrade.html" class="block px-4 py-2 text-sm text-gray-800 hover:bg-gray-100">Upgrade</a>
        <a href="settings.html" class="block px-4 py-2 text-sm text-gray-800 hover:bg-gray-100">Settings</a>
        <button onclick="logoutUser()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Log Out</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex flex-col items-center p-6">
    <h1 class="text-2xl font-bold kaymar-green mb-4">Quote Generator</h1>

    <!-- Kai Response Chat -->
    <div id="kaiResponse" class="w-full max-w-3xl bg-white p-4 mb-6 border rounded shadow space-y-4"></div>

    <!-- Input -->
    <div class="w-full max-w-3xl flex items-center space-x-2 mb-6">
      <input id="quoteInput" type="text" placeholder="Describe your project..." class="flex-1 border p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
      <button id="quoteSubmit" class="bg-black text-white px-6 py-2 rounded hover:bg-gray-900 transition">Generate</button>
    </div>

    <!-- Quote Output -->
    <div id="quoteOutput" class="w-full max-w-3xl bg-gray-50 p-4 border rounded shadow text-sm whitespace-pre-wrap"></div>

    <p class="text-xs text-gray-500 mt-4 max-w-2xl text-center">
      * This quote is for estimating purposes only and assumes typical materials and practices in your region.<br>
      Always double-check quantities and code requirements before ordering. You can copy and paste this quote into your preferred accounting software (e.g., Xero, MYOB, QuickBooks).
    </p>
  </main>

  <!-- Script -->
  <script>
    const messages = [
      {
        role: "system",
        content: `You are Kai Marlow – a construction quoting expert.
Ask follow-up questions to gather dimensions, materials, location, standards (like NCC, AS1684). Use metric units. After gathering enough info, generate a clear itemised list of materials for the job, including estimated quantities.

Only include MATERIALS, not labour. Estimate cuts, lengths (rounding to nearest stock size), spacing, and sheet coverage.

Maintain memory of user chat to refine the quote. Keep the quote section updated each time.`
      }
    ];

    document.getElementById('quoteSubmit').addEventListener('click', async () => {
      const input = document.getElementById('quoteInput').value.trim();
      const responseDiv = document.getElementById('kaiResponse');
      const outputDiv = document.getElementById('quoteOutput');

      if (!input) return;

      messages.push({ role: "user", content: input });

      const chat = document.createElement('div');
      chat.className = 'text-right text-blue-700 font-semibold';
      chat.textContent = `You: ${input}`;
      responseDiv.appendChild(chat);

      const reply = document.createElement('div');
      reply.className = 'text-left text-green-600 font-semibold';
      reply.textContent = "Kai is thinking...";
      responseDiv.appendChild(reply);

      try {
        const res = await fetch('https://askkai-backend-clean.onrender.com/quote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages })
        });

        const data = await res.json();
        const finalText = data.reply || "Couldn’t calculate. Try again.";

        reply.textContent = finalText;
        outputDiv.textContent = finalText;

        messages.push({ role: "assistant", content: finalText });

      } catch (err) {
        console.error(err);
        reply.textContent = "Something went wrong. Try again.";
      }

      document.getElementById('quoteInput').value = "";
      responseDiv.scrollTop = responseDiv.scrollHeight;
    });

    function toggleMenu() {
      document.getElementById('menuDropdown').classList.toggle('hidden');
    }

    function logoutUser() {
      sessionStorage.clear();
      window.location.href = 'landing.html';
    }
  </script>
</body>
</html>
