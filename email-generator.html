<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Generator – Ask Kai</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      background-image: url('https://i.imgur.com/jhqlVA5.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      font-family: sans-serif;
    }
    @media (max-width: 768px) {
      body { background-image: url('https://i.imgur.com/qzRmu0O.jpeg'); }
    }
    .overlay { background-color: rgba(255, 255, 255, 0.92); backdrop-filter: blur(5px); }
    #chatHistory { max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
    #finalDraft { min-height: 150px; white-space: pre-wrap; border: 1px solid #ccc; padding: 1rem; border-radius: 0.5rem; background: #fff; }
  </style>
</head>
<body class="text-gray-800">

<!-- Banner with Menu -->
<div class="w-full bg-black relative p-4 flex items-center justify-between">
  <button onclick="toggleMenu()" class="bg-white text-black p-2 rounded shadow">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
    </svg>
  </button>
  <img src="https://i.imgur.com/nDIhtRr.png" alt="Kaymar Banner" class="max-h-24 mx-auto object-contain" />
  <div id="menuDropdown" class="hidden absolute left-4 mt-16 w-48 bg-white border border-gray-300 shadow-lg rounded-md z-50">
    <a href="index.html" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">Home</a>
    <a href="settings.html" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">Settings</a>
    <button onclick="logoutUser()" class="w-full text-left px-4 py-2 text-red-600 hover:bg-gray-100">Log Out</button>
  </div>
</div>

<main class="max-w-3xl mx-auto py-8 px-4 space-y-6 overlay mt-10 rounded-xl">
  <div class="bg-white p-6 rounded-xl shadow space-y-4">
    <label class="block font-semibold mb-2">What would you like to say?</label>
    <textarea id="emailInput" rows="3" class="w-full border rounded-lg p-3" placeholder="E.g., Tell the client I’ll be there Friday arvo to finish the decking job..."></textarea>
    <button id="submitPrompt" class="mt-2 w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">Draft with Kai</button>
  </div>

  <!-- Chat History -->
  <div id="chatHistory" class="bg-white p-6 rounded-xl shadow text-sm space-y-2 text-gray-800"></div>

  <!-- Final Draft -->
  <h2 class="text-xl font-bold text-green-600">Draft Email</h2>
  <div id="finalDraft" class="mb-4"></div>

  <!-- Recipient Selection -->
  <div class="bg-white p-6 rounded-xl shadow space-y-4">
    <label class="block text-sm font-semibold">Select Recipient</label>
    <select id="recipientDropdown" class="w-full border p-2 rounded">
      <option value="">Select Recipient</option>
      <optgroup label="Contacts"></optgroup>
      <optgroup label="Suppliers"></optgroup>
    </select>
    <button id="sendEmailBtn" class="w-full bg-black hover:bg-gray-900 text-white py-2 rounded-lg">Send Email</button>
    <button id="saveDraftBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg mt-2">Save Draft</button>
  </div>

  <div class="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded shadow">
    <p>This generated email is a draft. Please review before sending.</p>
  </div>
</main>

<footer class="text-center text-gray-500 text-sm p-6 mt-10">
  &copy; 2025 Kaymar Construction | Powered by Ask Kai
  <div class="flex justify-center space-x-6 mt-2">
    <a href="#" class="text-blue-600 hover:underline">Instagram</a>
    <a href="#" class="text-blue-600 hover:underline">TikTok</a>
    <a href="#" class="text-blue-600 hover:underline">Facebook</a>
    <a href="#" class="text-blue-600 hover:underline">YouTube</a>
    <a href="#" class="text-blue-600 hover:underline">Threads</a>
  </div>
</footer>

<script>
const SUPABASE_URL = 'https://ndvmxpkoyoimibntetef.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kdm14cGtveW9pbWlibnRldGVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1MDgxODksImV4cCI6MjA2MjA';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let messages = [{
  role: "system",
  content: "You are Kai Marlow, a seasoned Aussie tradie and master communicator. You help blokes write clear, professional, and friendly emails without the fluff. Keep it casual but respectful, suitable for clients, suppliers, or contractors. If the user asks for a draft, create it using Aussie spelling and construction lingo. Always keep it brief and to the point, but make sure it sounds polite and professional. If follow-up prompts are provided, adjust the draft accordingly until the user is happy. Provide the email body only, no subject lines unless asked specifically."
}];

const emailInput = document.getElementById('emailInput');
const chatHistory = document.getElementById('chatHistory');
const finalDraft = document.getElementById('finalDraft');
const submitPrompt = document.getElementById('submitPrompt');
const sendEmailBtn = document.getElementById('sendEmailBtn');
const saveDraftBtn = document.getElementById('saveDraftBtn');
const recipientDropdown = document.getElementById('recipientDropdown');

submitPrompt.addEventListener('click', async () => {
  const userInput = emailInput.value.trim();
  if (!userInput) return;

  messages.push({ role: "user", content: userInput });
  chatHistory.innerHTML += `<div><strong>You:</strong> ${userInput}</div>`;
  emailInput.value = '';
  chatHistory.innerHTML += `<div><strong>Kai:</strong> Crafting your draft...</div>`;
  chatHistory.scrollTop = chatHistory.scrollHeight;

  try {
    const response = await fetch("https://askkai-backend-clean.onrender.com/generate-email", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages })
    });

    const data = await response.json();
    const reply = data.reply || "Kai couldn’t generate an email. Try again.";
    messages.push({ role: "assistant", content: reply });

    chatHistory.lastChild.innerHTML = `<strong>Kai:</strong> ${reply}`;
    finalDraft.innerText = reply;

  } catch (error) {
    console.error("Error:", error);
    chatHistory.lastChild.innerHTML = `<strong>Kai:</strong> Error generating draft.`;
  }
});

sendEmailBtn.addEventListener('click', () => {
  const recipient = recipientDropdown.value;
  if (!recipient) return alert('Please select a recipient.');

  const latestDraft = [...messages].reverse().find(msg => msg.role === "assistant")?.content;
  if (!latestDraft) return alert('No draft generated yet.');

  const subject = encodeURIComponent("Follow-up Regarding Our Project");
  const body = encodeURIComponent(latestDraft);

  window.location.href = `mailto:${recipient}?subject=${subject}&body=${body}`;
});

saveDraftBtn.addEventListener('click', async () => {
  const userId = sessionStorage.getItem('askkaiUserId');
  const latestDraft = [...messages].reverse().find(msg => msg.role === "assistant")?.content;

  if (!userId) return alert('User not logged in.');
  if (!latestDraft) return alert('No draft to save.');

  const { data, error } = await supabase
    .from('users')
    .update({ saved_emails: supabase.raw('array_append(saved_emails, ?)', [latestDraft]) })
    .eq('id', userId);

  if (error) {
    console.error("Error saving draft:", error);
    alert('Failed to save draft.');
  } else {
    alert('Draft saved successfully.');
  }
});

async function loadRecipients() {
  const userId = sessionStorage.getItem('askkaiUserId');
  if (!userId) return;

  const { data } = await supabase.from('users').select('saved_contacts, saved_suppliers').eq('id', userId).single();

  const contactsGroup = recipientDropdown.querySelector('optgroup[label="Contacts"]');
  const suppliersGroup = recipientDropdown.querySelector('optgroup[label="Suppliers"]');

  contactsGroup.innerHTML = '';
  suppliersGroup.innerHTML = '';

  if (data?.saved_contacts) {
    data.saved_contacts.forEach(contact => {
      const option = document.createElement('option');
      option.value = contact.email;
      option.textContent = `${contact.name} (${contact.email})`;
      contactsGroup.appendChild(option);
    });
  }

  if (data?.saved_suppliers) {
    data.saved_suppliers.forEach(supplier => {
      const option = document.createElement('option');
      option.value = supplier.email;
      option.textContent = `${supplier.name} (${supplier.email})`;
      suppliersGroup.appendChild(option);
    });
  }
}

function toggleMenu() {
  document.getElementById('menuDropdown').classList.toggle('hidden');
}

function logoutUser() {
  sessionStorage.clear();
  window.location.href = 'logout.html';
}

window.addEventListener('load', loadRecipients);
</script>

</body>
</html>
