<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign In â€“ Ask Kai</title>
  <script>
    window.SUPABASE_URL = "https://ndvmxpkoyoimibntetef.supabase.co";
    window.SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kdm14cGtveW9pbWlibnRldGVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1MDgxODksImV4cCI6MjA2MjA4NDE4OX0.-U4Jfb33aFfoAec-fhhFqjHExezWcKoEYwkSVgibjE4";
    const supabase = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_KEY);
  </script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
</head>
<body>
<!-- Your HTML Content Remains the Same -->
<script>
const toast = document.getElementById('toast');
const signinBtn = document.getElementById('signin-btn');

function showToast(message, duration = 3000) {
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), duration);
}

function disableButton(state) {
  signinBtn.disabled = state;
  signinBtn.innerHTML = state ? '<span class="spinner"></span> Signing In...' : 'Sign In';
}

function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

async function handleUserRecord() {
  const { data: userData } = await supabase.auth.getUser();
  if (userData?.user?.id) {
    const { data: existingUser } = await supabase.from('users').select('id').eq('id', userData.user.id).single();
    if (!existingUser) {
      await supabase.from('users').insert([{ 
        id: userData.user.id, 
        email: userData.user.email, 
        plan_tier: 'Free',
        prompt_count: 0,
        created_at: new Date().toISOString()
      }]);
    }
  }
}

async function signInWithEmail() {
  const email = document.getElementById('email').value.trim().toLowerCase();
  const password = document.getElementById('password').value.trim();

  if (!validateEmail(email)) return showToast("Invalid email format.");
  if (!password) return showToast("Password cannot be empty.");

  disableButton(true);

  try {
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) return showToast(error.message);
    await handleUserRecord();
    showToast("Sign in successful.");
    setTimeout(() => window.location.href = 'index.html', 1000);
  } catch (err) {
    showToast("Unexpected error during sign in.");
  } finally {
    disableButton(false);
  }
}

function signInWithFacebook() {
  supabase.auth.signInWithOAuth({
    provider: 'facebook',
    options: { redirectTo: `${window.location.origin}/index.html` }
  })
  .then(() => handleUserRecord())
  .catch(err => showToast(`Facebook Sign-In Error: ${err.message}`));
}

function handleOAuthLogin(response) {
  handleUserRecord();
}

window.fbAsyncInit = function() {
  FB.init({
    appId: '2841591242694736',
    cookie: true,
    xfbml: true,
    version: 'v15.0'
  });
};

(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "https://connect.facebook.net/en_US/sdk.js";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script>
</body>
</html>
