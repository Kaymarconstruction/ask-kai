<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Materials List â€“ Ask Kai</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto py-10 px-4">
    <h1 class="text-3xl font-bold mb-6 text-center text-green-700">Available Materials</h1>

    <div class="mb-4 flex justify-end space-x-2">
      <label for="sortSelect" class="text-sm font-medium self-center">Sort by:</label>
      <select id="sortSelect" class="border border-gray-300 rounded p-2 text-sm">
        <option value="price_asc">Price (Low to High)</option>
        <option value="price_desc">Price (High to Low)</option>
        <option value="length_asc">Length (Short to Long)</option>
        <option value="length_desc">Length (Long to Short)</option>
      </select>
    </div>

    <table class="w-full table-auto bg-white shadow rounded">
      <thead class="bg-green-100 text-left">
        <tr>
          <th class="p-3">Name</th>
          <th class="p-3">Supplier</th>
          <th class="p-3">Category</th>
          <th class="p-3">Price</th>
          <th class="p-3">Scraped</th>
        </tr>
      </thead>
      <tbody id="materialsTable" class="divide-y divide-gray-200"></tbody>
    </table>
  </div>

  <script>
    async function loadMaterials() {
      try {
        const response = await fetch('https://askkai-backend-clean.onrender.com/materials');
        const data = await response.json();

        let materials = data.materials || [];
        const tableBody = document.getElementById('materialsTable');
        const sortSelect = document.getElementById('sortSelect');

        function renderTable(items) {
          tableBody.innerHTML = '';
          items.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="p-3">${item.name}</td>
              <td class="p-3">${item.supplier}</td>
              <td class="p-3">${item.category}</td>
              <td class="p-3">$${item.price_per_unit?.toFixed(2) || '-'}</td>
              <td class="p-3">${new Date(item.scraped_at).toLocaleDateString()}</td>
            `;
            tableBody.appendChild(tr);
          });
        }

        sortSelect.addEventListener('change', () => {
          const sortBy = sortSelect.value;
          if (sortBy === 'price_asc') materials.sort((a, b) => a.price_per_unit - b.price_per_unit);
          else if (sortBy === 'price_desc') materials.sort((a, b) => b.price_per_unit - a.price_per_unit);
          else if (sortBy === 'length_asc') materials.sort((a, b) => extractLength(a.name) - extractLength(b.name));
          else if (sortBy === 'length_desc') materials.sort((a, b) => extractLength(b.name) - extractLength(a.name));
          renderTable(materials);
        });

        function extractLength(name) {
          const match = name.match(/(\d+(\.\d+)?)\s?m/);
          return match ? parseFloat(match[1]) : 0;
        }

        renderTable(materials);
      } catch (err) {
        console.error('Failed to load materials:', err);
      }
    }

    loadMaterials();
  </script>
</body>
</html>

