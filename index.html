<script>
const submitButton = document.getElementById('submitBtn');
const askInput = document.getElementById('askInput');
const kaiReply = document.getElementById('kaiReply');

// New: Store conversation history
const messages = [
  { role: "system", content: "You are Kai Marlow â€” a friendly Aussie tradie with 20+ years of experience. Give fast, practical advice in clear, confident language." }
];

submitButton.addEventListener('click', async () => {
  const userQuestion = askInput.value.trim();
  if (!userQuestion) {
    return;
  }

  // Add user's new message to chat history
  messages.push({ role: "user", content: userQuestion });

  // Create a container for the new Q&A
  const qaContainer = document.createElement('div');
  qaContainer.className = 'mb-6';

  const userText = document.createElement('p');
  userText.className = 'text-right text-blue-700 font-semibold mb-2';
  userText.textContent = `You: ${userQuestion}`;
  qaContainer.appendChild(userText);

  const kaiText = document.createElement('p');
  kaiText.className = 'text-left text-green-600 font-semibold';
  kaiText.textContent = "Kai is thinking...";
  qaContainer.appendChild(kaiText);

  kaiReply.appendChild(qaContainer);
  kaiReply.scrollTop = kaiReply.scrollHeight;
  askInput.value = "";

  try {
    const response = await fetch('https://askkai-backend-clean.onrender.com/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages: messages })
    });

    const data = await response.json();
    const finalText = data.reply || "Hmm, couldn't find an answer!";
    kaiText.textContent = "";
    let i = 0;
    const speed = 40;

    function typeWriter() {
      if (i < finalText.length) {
        kaiText.textContent += finalText.charAt(i);
        i++;
        setTimeout(typeWriter, speed);
      }
    }

    typeWriter();

    // Add Kai's reply to chat history
    messages.push({ role: "assistant", content: finalText });

  } catch (error) {
    console.error(error);
    kaiText.textContent = "Error reaching Kai. Try again later.";
  }
});
</script>
