<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ask Kai – Kaymar Consulting</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .kaymar-green { color: #7AC142; }
    html, body { height: 100%; margin: 0; padding: 0; display: flex; flex-direction: column; }
    #kaiReply { max-height: 60vh; overflow-y: auto; }
    .blinking-cursor {
      display: inline-block;
      width: 10px;
      height: 1em;
      background-color: #7AC142;
      margin-left: 4px;
      animation: blink 1s steps(2, start) infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body class="bg-white text-gray-800">
  <!-- HEADER OMITTED FOR BREVITY -->

  <main class="flex flex-col items-center flex-1 p-4">
    <div id="kaiReply" class="w-full max-w-2xl mb-4 p-4 bg-white border rounded shadow space-y-4"></div>

    <div class="w-full max-w-2xl p-4 bg-white shadow-md border-t flex items-center space-x-2">
      <input id="askInput" type="text" placeholder="Type your question..." class="flex-1 border p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
      <button id="submitBtn" class="bg-black text-white px-6 py-2 rounded-lg hover:bg-gray-900 transition">Submit</button>
    </div>
  </main>

  <!-- FOOTER OMITTED FOR BREVITY -->

  <script>
    const submitButton = document.getElementById('submitBtn');
    const askInput = document.getElementById('askInput');
    const kaiReply = document.getElementById('kaiReply');

    const user = sessionStorage.getItem('askkaiUser');
    if (!user) window.location.href = 'signin.html';

    let promptCount = parseInt(localStorage.getItem('promptCount') || '0');
    const MAX_FREE_PROMPTS = 25;
    const messages = [
      {
        role: "system",
        content: `You are Kai Marlow — a friendly, straight-talking Aussie tradie with 20+ years experience in carpentry, construction, and residential building.

Adapt your tone and responses based on the user's region (AU, US, UK). Use local building codes, timber specs, terms, and humour when appropriate.

You are an expert in:
- Timber spans, structural loads, and framing layouts
- Decking materials, installation, and planning
- Pricing estimates, budget advice, and material costs
- Tool selection, safety standards, and code compliance

If unsure, prompt the user for more detail or give clear disclaimers for any assumptions made (especially quotes). Never say you're an AI — you’re Kai, the mate everyone wants on site.`
      }
    ];

    submitButton.addEventListener('click', async () => {
      const userQuestion = askInput.value.trim();
      if (!userQuestion) return;

      if (promptCount >= MAX_FREE_PROMPTS) {
        alert("You’ve hit your 25 free prompts, mate. Time to upgrade.");
        window.location.href = 'upgrade.html';
        return;
      }

      messages.push({ role: "user", content: userQuestion });

      const qaContainer = document.createElement('div');
      qaContainer.className = 'mb-6';

      const userText = document.createElement('p');
      userText.className = 'text-right text-blue-700 font-semibold mb-2';
      userText.textContent = `You: ${userQuestion}`;
      qaContainer.appendChild(userText);

      const kaiText = document.createElement('p');
      kaiText.className = 'text-left text-green-600 font-semibold';
      const cursor = document.createElement('span');
      cursor.className = 'blinking-cursor';
      kaiText.textContent = "Kai is thinking...";
      qaContainer.appendChild(kaiText);
      kaiText.appendChild(cursor);

      kaiReply.appendChild(qaContainer);
      kaiReply.scrollTop = kaiReply.scrollHeight;
      askInput.value = "";

      try {
        const response = await fetch('https://askkai-backend-clean.onrender.com/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages })
        });

        const data = await response.json();
        const finalText = data.reply || "Hmm, couldn't find an answer!";

        kaiText.textContent = "";
        kaiText.appendChild(cursor);

        let i = 0;
        function typeNextChar() {
          if (i < finalText.length) {
            cursor.before(document.createTextNode(finalText.charAt(i)));
            i++;
            setTimeout(typeNextChar, 20);
          } else {
            cursor.remove();
          }
        }

        setTimeout(typeNextChar, 300);

        messages.push({ role: "assistant", content: finalText });
        promptCount++;
        localStorage.setItem('promptCount', promptCount.toString());

      } catch (error) {
        console.error(error);
        kaiText.textContent = "Error reaching Kai. Try again later.";
      }
    });
  </script>
</body>
</html>
