<script>
  const user = sessionStorage.getItem('askkaiUser');
  if (!user) window.location.href = 'signin.html';

  const isMark = user === 'mark@kaymarconstruction.com';
  let promptCount = parseInt(localStorage.getItem('promptCount') || '0');
  const MAX_FREE_PROMPTS = 10;

  const messages = [{
    role: "system",
    content: `You are Kai Marlow — a practical Aussie chippy and estimator. Your replies are short (under 100 words), list-based where possible, and never include disclaimers. Use bullet points like "• Joists: 90x45mm..." and skip fluff.`
  }];

  document.getElementById('submitBtn').addEventListener('click', async () => {
    const askInput = document.getElementById('askInput');
    const kaiReply = document.getElementById('kaiReply');
    const userQuestion = askInput.value.trim();
    if (!userQuestion) return;

    if (!isMark && promptCount >= MAX_FREE_PROMPTS) {
      alert("You’ve hit your 10 free prompts. Time to upgrade.");
      window.location.href = 'upgrade.html';
      return;
    }

    messages.push({ role: "user", content: userQuestion });

    const qaContainer = document.createElement('div');
    qaContainer.className = 'mb-6';

    const userText = document.createElement('p');
    userText.className = 'text-right text-blue-700 font-semibold mb-2';
    userText.textContent = `You: ${userQuestion}`;
    qaContainer.appendChild(userText);

    const kaiText = document.createElement('p');
    kaiText.className = 'text-left text-green-700 font-semibold whitespace-pre-wrap';
    kaiText.textContent = "Kai is thinking...";
    qaContainer.appendChild(kaiText);

    kaiReply.appendChild(qaContainer);
    kaiReply.scrollTop = kaiReply.scrollHeight;
    askInput.value = "";

    try {
      const response = await fetch('https://askkai-backend-clean.onrender.com/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages })
      });

      const data = await response.json();
      let finalText = data.reply || "Kai’s stumped. Try again shortly.";

      // Trim disclaimer + verbose prefix
      finalText = finalText
        .replace(/^(Absolutely.*?)?(Here's|Here is).*?:/is, '')
        .replace(/(Please note|This estimate).*$/gis, '')
        .replace(/✓/g, '•') // Convert ticks to bullets
        .replace(/- /g, '• ') // Convert hyphen bullets
        .trim();

      kaiText.textContent = `Kai:\n${finalText}`;
      messages.push({ role: "assistant", content: finalText });

      if (!isMark) {
        promptCount++;
        localStorage.setItem('promptCount', promptCount.toString());
      }

    } catch (error) {
      console.error(error);
      kaiText.textContent = "Error reaching Kai. Try again later.";
    }
  });
</script>
