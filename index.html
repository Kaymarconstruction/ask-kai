<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ask Kai – Site Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .chat-bubble {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      margin-bottom: 0.5rem;
      display: inline-block;
    }
    .user-bubble {
      background-color: #DCFCE7;
      align-self: flex-end;
    }
    .kai-bubble {
      background-color: #E5E7EB;
      align-self: flex-start;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Banner -->
  <div class="w-full bg-black">
    <img src="https://i.imgur.com/nDIhtRr.png" alt="Kaymar Banner" class="w-full max-h-24 object-contain mx-auto">
  </div>

  <!-- Header -->
  <header class="bg-white shadow p-4 flex items-center justify-between">
    <h1 class="text-xl font-bold text-green-600">Ask Kai – Your Site Assistant</h1>
    <a href="settings.html" class="text-sm text-blue-600 hover:underline">Settings</a>
  </header>

  <!-- Main Chat Window -->
  <main class="max-w-3xl mx-auto py-6 px-4">
    <div id="chatBox" class="flex flex-col space-y-2 bg-white p-4 rounded-xl shadow min-h-[40vh] mb-6 overflow-y-auto"></div>

    <div class="flex items-center gap-2">
      <textarea id="userInput" rows="2" class="flex-1 border rounded-lg p-2" placeholder="Ask me anything about your project..."></textarea>
      <button id="sendBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Send</button>
    </div>
  </main>

  <!-- Footer -->
  <footer class="text-center text-gray-500 text-sm p-6">
    &copy; 2025 Kaymar Construction | Powered by Ask Kai
    <div class="flex justify-center space-x-6 mt-2">
      <a href="https://www.instagram.com/askkai_official" class="text-blue-600 hover:underline">Instagram</a>
      <a href="https://www.tiktok.com/@askkai_official" class="text-blue-600 hover:underline">TikTok</a>
      <a href="https://www.facebook.com/askkai_official" class="text-blue-600 hover:underline">Facebook</a>
      <a href="https://www.youtube.com/@askkai_official" class="text-blue-600 hover:underline">YouTube</a>
      <a href="https://www.threads.net/@askkai_official" class="text-blue-600 hover:underline">Threads</a>
    </div>
  </footer>

  <!-- JS -->
  <script>
    const chatBox = document.getElementById('chatBox');
    const sendBtn = document.getElementById('sendBtn');
    const userInput = document.getElementById('userInput');

    function addBubble(content, sender) {
      const div = document.createElement('div');
      div.className = `chat-bubble ${sender === 'user' ? 'user-bubble self-end' : 'kai-bubble self-start'}`;
      div.innerHTML = content;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    sendBtn.addEventListener('click', async () => {
      const input = userInput.value.trim();
      if (!input) return;

      addBubble(input, 'user');
      userInput.value = '';

      addBubble("<span class='text-green-600 font-medium'>Kai is thinking...</span>", 'kai');

      const response = await fetch("https://askkai-backend-clean.onrender.com/quote", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages: [ { role: "user", content: input } ] })
      });

      const data = await response.json();
      chatBox.lastChild.remove(); // Remove "Kai is thinking..."

      let reply = data.reply || "Kai couldn’t help this time.";
      reply = reply
        .replace(/^(Absolutely.*?)?(Here's|Here is).*?estimate.*?:\n?/is, '')
        .replace(/✓/g, '•')
        .replace(/\n?This estimate is for materials only\..*$/is, '')
        .trim();

      addBubble(reply.replace(/\n/g, '<br>'), 'kai');
    });
  </script>
</body>
</html>
